import sgMail from "@sendgrid/mail";
import Busboy from "busboy";

sgMail.setApiKey(process.env.SENDGRID_API_KEY);

export const handler = async (event) => {
  if (event.httpMethod !== "POST") {
    return { statusCode: 405, body: "Method Not Allowed" };
  }

  try {
    const fields = {};
    const attachments = [];

    await new Promise((resolve, reject) => {
      const busboy = Busboy({ headers: event.headers });

      busboy.on("field", (name, value) => {
        fields[name] = value;
      });

      busboy.on("file", (name, file, info) => {
        let buffer = [];
        file.on("data", (data) => buffer.push(data));
        file.on("end", () => {
          attachments.push({
            content: Buffer.concat(buffer).toString("base64"),
            filename: info.filename,
            type: info.mimeType,
            disposition: "attachment",
          });
        });
      });

      busboy.on("finish", resolve);
      busboy.on("error", reject);

      busboy.end(Buffer.from(event.body, "base64"));
    });

    // Build the email body
    const emailContent = `
      ðŸ“© New Contact Form Submission

      Full Name: ${fields.name || ""}
      Email: ${fields.email || ""}
      Company/Agency: ${fields.company || ""}
      Phone: ${fields.phone || ""}
      Service Area: ${fields.service || ""}
      Timeline: ${fields.timeline || ""}
      Location: ${fields.location || ""}
      Details/Scope: ${fields.details || ""}
    `;

    const msg = {
      to: process.env.TO_EMAIL,
      from: process.env.FROM_EMAIL,
      subject: "New RFQ Submission - Reed Solutions LLC",
      text: emailContent,
      attachments: attachments.length ? attachments : undefined,
    };

    await sgMail.send(msg);

    return {
      statusCode: 303,
      headers: { Location: "/thanks.html" },
      body: "",
    };
  } catch (err) {
    console.error("SendGrid Error:", err);
    return {
      statusCode: 500,
      body: JSON.stringify({ error: err.message }),
    };
  }
};
